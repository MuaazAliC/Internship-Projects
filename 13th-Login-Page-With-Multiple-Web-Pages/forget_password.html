<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link rel="stylesheet" href="style.css">
 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     <style>
        #fp_otp{
    
            text-align: center;
            letter-spacing: 12px;
        }
     </style>
</head>
<body>
<div class="container">
    <div id="loader" class="loader">Loading...</div>
    <div id="errorBox" class="error-box"></div>
    <div id="ok" class="ok"></div>

    <h2>Forgot Password</h2>

    <input type="email" id="fp_email" placeholder="Enter Email">
    <button id="send_otp">Send OTP</button>

    <input type="text" id="fp_otp" placeholder="Enter OTP" style="display:none;">
   
    <button id="verifyOTP_forget" style="display:none;">Verify OTP</button>

    <div style="position: relative;">
        <input type="password" id="new_password" placeholder="New Password" style="display:none; padding-right: 30px;">
        <i id="toggle_new_password" class="fa-solid fa-eye" style="display:none; position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer;"></i>
    </div>

    <div style="position: relative;">
        <input type="password" id="confirm_password" placeholder="Confirm Password" style="display:none; padding-right: 30px;">
        <i id="toggle_confirm_password" class="fa-solid fa-eye" style="display:none; position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer;"></i>
    </div>

    <button id="reset_btn" style="display:none;">Reset Password</button>

    <p><a href="login.html">Back to Login</a></p>
    <div id="forgot_message"></div>
</div>

<script>
function togglePasswordVisibility(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    if (!input || !icon) return;

    icon.addEventListener("click", () => {
        const isPassword = input.type === "password";
        input.type = isPassword ? "text" : "password";

        icon.classList.toggle("fa-eye", !isPassword);
        icon.classList.toggle("fa-eye-slash", isPassword);
    });
}

togglePasswordVisibility("new_password", "toggle_new_password");
togglePasswordVisibility("confirm_password", "toggle_confirm_password");
</script>

<script>
    const url = "Your API"; 





const forget_email = document.getElementById("fp_email");
const forget_otp = document.getElementById("fp_otp");
const forget_otp_verify = document.getElementById("verifyOTP_forget");
const forget_password = document.getElementById("new_password")
const forget_confirm_password = document.getElementById("confirm_password")
const reset_btn = document.getElementById("reset_btn");

const errorBox = document.getElementById("errorBox");
const loader = document.getElementById("loader");
const ok = document.getElementById("ok");



document.getElementById("send_otp").addEventListener("click", async () => {
  if(forget_email){
     Send_OTP(forget_email, "forgot");
  }
  else{
     showError("Enter your email first.");
  }
});
forget_otp_verify.addEventListener("click", async () => {
    if(forget_otp){
       OTP_VERIFY(forget_email, forget_otp, "forgot");
    }
    else{
       showError("Please Enter OTP First.");
    }
});

reset_btn.addEventListener("click", async () => {
   if (
    !forget_password ||
    !forget_confirm_password
  ) {
    return showError("Please fill all fields.");
  }

  if (forget_password.value !== forget_confirm_password.value)
    return showError("Passwords do not match.");

  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;
  if (!passwordRegex.test(forget_password.value))
    return showError(
      "Password must be 8+ characters, include uppercase, lowercase, number, and special char."
    );
showLoader(true);
  ChangePassword(forget_password, forget_confirm_password);
});


async function Send_OTP(email,otp_type) {
  {
  if (!email.value.trim()) return showError("Enter your email first.");
  showLoader(true);
  try {
    const res = await fetch(`${url}otp/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: email.value.trim(),
        otp_type: otp_type,
        role: "user",
      }),
    });
    const data = await res.json();
    if (res.ok) {
      ShowOK("OTP sent successfully.");
     if(otp_type === "forgot"){
        forget_otp.style.display = "block";
        forget_otp_verify.style.display= "block";
     }
      
    } else {
      showError(data.message || "Failed to send OTP.");
    }
  } catch (err) {
    showError("Error sending OTP.");
  } finally {
    showLoader(false);
  }
}
}

async function OTP_VERIFY(Email,OTP,otp_type)  {

  try {
    const res = await fetch(`${url}otp/verify`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: Email.value.trim(),
        otp_code: OTP.value.trim(),
        otp_type: otp_type,
        role: "user",
      }),
    });

    const data = await res.json();
    if (res.ok) {
      registerToken = data.verification_token.join("");
      ShowOK("OTP verified.");
      if(otp_type === "forgot") {
        forget_otp.style.display = "none";
        forget_otp_verify.style.display= "none";
        forget_email.style.display = "none";
        document.getElementById("send_otp").style.display = "none";
        document.getElementById("reset_btn").style.display = "block";
        forget_password.style.display = "block";
        document.getElementById("toggle_new_password").style.display = "block";
        forget_confirm_password.style.display = "block";
        document.getElementById("toggle_confirm_password").style.display = "block";
      }
    } else {
      showError(data.message || "Failed to verify OTP.");
    }
  } catch (err) {
    showError("Error verifying OTP.");
  } finally {
    showLoader(false);
  }
}
async function ChangePassword(password, confirm_password)  {
  try {
    const res = await fetch(`${url}profile/password/reset`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        password: password.value.trim(),
        confirm_password: confirm_password.value.trim(),
        verification_token: registerToken,
        role: "user",
      }),
    });

    const data = await res.json();
    if (res.ok) {
      ShowOK("Password changed successfully.");
    
    } else {
      showError(data.message || "Failed to change password.");
    }
  } catch (err) {
    showError("Error changing password.");
  } finally {
    showLoader(false);
  }
}




function showLoader(show) {
  loader.style.display = show ? "block" : "none";
}


function showError(message) {
  errorBox.innerText = message;
  errorBox.style.display = "block";
  setTimeout(() => (errorBox.style.display = "none"), 10000);
}
function ShowOK(message) {
  ok.innerText = message;
  ok.style.display = "block";
  setTimeout(() => (ok.style.display = "none"), 10000);
}
</script>
</body>
</html>
